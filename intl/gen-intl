#!/bin/sh

PRE="../src/intl/lng_"

#passing any parameter will force total update
if [ -n "$1" ]; then
	rm -f "$PRE"*'.inc'
	rm -f "../src/intl/lang_defs.h"
	rm -f "../src/intl/language.inc"
fi

echo
echo Generating language table.
languages=`cat index.txt`
if [ -n "$languages" ]; then
(
n=0
echo '/* Automaticaly generated by gen-intl */'
for i in $languages; do
	A=$i" .................................................."
	echo -n ${A:0:30} 1>&2
	echo '/* Automaticaly generated by gen-intl */' > "$PRE$i.t"
	echo >> "$PRE$i.t"
	echo 'struct translation translation_'$i' [] = {' >> "$PRE$i.t"
	echo '  {T_NIL_, NULL},' >> "$PRE$i.t"
	sed 's/^/  {/; s/,*$/},/; s///g' $i.lng >> "$PRE$i.t"
	echo '  {T_NIL_, NULL}' >> "$PRE$i.t"
	echo '};' >> "$PRE$i.t"
	if [ -e "$PRE$i.inc" ]; then
		D=`cmp "$PRE$i.inc" "$PRE$i.t"`
		if [ -n "$D" ]; then
			mv -f "$PRE$i.t" "$PRE$i.inc"
			echo " updated" 1>&2

		else
			rm -f "$PRE$i.t"
			echo " unchanged" 1>&2

		fi
	else
		mv -f "$PRE$i.t" "$PRE$i.inc"
		echo -e " updated" 1>&2
	fi
	n=`expr $n + 1`
done
echo
for i in $languages; do
	echo '#include "lng_'$i'.inc"'
done

echo
echo 'struct translation_desc translations [] = {'
for i in $languages; do
	echo '  {translation_'$i'},'
done
echo '  {NULL}'
echo '};'
echo
(
	echo '/* Automaticaly generated by gen-intl */'
	echo
	echo '#define N_LANGUAGES '$n
	echo
	echo 'enum translation_codes {'
	echo '	T_NIL_ = 0,'
	( grep '^T_' english.lng ; echo T__N_TEXTS ) | cut -d ',' -f1 | sed 's/^/	/;s/$/,/'
	echo '};'
) | sed 's///g' > ../src/intl/lang_defs.h.t
) | sed 's///g' > ../src/intl/language.inc.t

echo
echo -n "../src/intl/lang_defs.h  ....."
if [ -e "../src/intl/lang_defs.h" ]; then
	D=`cmp "../src/intl/lang_defs.h" "../src/intl/lang_defs.h.t"`
	if [ -n "$D" ]; then
		mv -f "../src/intl/lang_defs.h.t" "../src/intl/lang_defs.h"
		echo " updated" 1>&2
	else
		rm -f "../src/intl/lang_defs.h.t"
		echo " unchanged" 1>&2
	fi
else
	mv -f "../src/intl/lang_defs.h.t" "../src/intl/lang_defs.h"
	echo -e " updated" 1>&2
fi

echo -n "../src/intl/language.inc ....."
if [ -e "../src/intl/language.inc" ]; then
	D=`cmp "../src/intl/language.inc.t" "../src/intl/language.inc"`
	if [ -n "$D" ]; then
		mv -f "../src/intl/language.inc.t" "../src/intl/language.inc"
		echo " updated" 1>&2
	else
		rm -f "../src/intl/language.inc.t"
		echo " unchanged" 1>&2
	fi
else
	mv -f "../src/intl/language.inc.t" "../src/intl/language.inc"
	echo -e " updated" 1>&2
fi

echo timestamp >../src/intl/stamp-intl

echo
echo Done.
fi
echo
