#!/bin/sh
#
# $Id: help2docbook,v 1.3 2003/06/11 22:33:17 jonas Exp $
#
# Script used to generate doc/book/config/cmdoptions.xml
# and hopefully other in the future.

VERSION="\$Revision: 1.3 $"
DATE=`date +"%d %B %y"`
SCRIPTINFO="Generated by $0 ($VERSION) on $DATE. DO NOT EDIT!"

# Option handling {{{1

format=$1

case "$format" in
	-long-help)
		backend="long_help"
		# 
	;;
	*)
		echo "Usage: $0 [-long-help]"
		exit -1
	;;
esac

# State variables {{{1

parse_description=
use_log=
option_stack=

# Utility functions {{{1

log()
{
	log_msg=$1
	if test -n "$use_log";
	then
		echo $log_msg
	fi
}

escape_string()
{
	string=$1
	echo $string | sed -e "s/</\&lt;/" -e "s/>/\&gt;/"
}

# Backends {{{1

print_header="print_${backend}_header"
print_footer="print_${backend}_footer"
print_description_end="print_${backend}_description_end"
print_description_line="print_${backend}_description_line"
print_option_line="print_${backend}_option_line"

# -long-help backend {{{2

print_long_help_header()
{
	echo "<!-- $SCRIPTINFO -->"
	echo "<variablelist>"
}

print_long_help_footer()
{
	echo "</variablelist>"
}

print_long_help_description_end()
{
	echo "</para></listitem></varlistentry>"
	echo ""
}

print_long_help_description_line()
{
	line="$1"
	escape_string "$line"
}

print_long_help_option_line()
{
	line="$1"
	echo "<varlistentry><term> $option_stack $(escape_string "$line") </term><listitem><para>"
}

# The main loop {{{1

eval $print_header

while read line
do
	if test -n "$parse_description"
	then
		# If the line is empty it is our clue that
		# the desciption is over.
		if test -z "$line"
		then
			eval $print_description_end
			parse_description=
			continue
		fi

		eval "$print_description_line \"$line\""
		continue
	fi

	# Handle special case for -h and -?
	case "$line" in
	-h | -?)
		if test -z "$option_stack";
		then
			option_stack="$line,"
		else
			option_stack="$option_stack $line,"
		fi
		;;
	-[a-z]*)
		parse_description=1
		eval "$print_option_line \"$line\""
		option_stack=
		;;
	*)
		;;
	esac
done

eval $print_footer

# vim: tabstop=4 shiftwidth=4
